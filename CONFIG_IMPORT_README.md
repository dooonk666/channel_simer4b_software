# 配置导入功能说明

## 功能概述

在上位机界面上添加了"导入配置"和"应用配置"两个按钮，支持从JSON文件导入信道配��并自动生成帧发送到设备。

## 主要特性

1. **支持24条多径**：系统现在支持最多24个多径（原来是16个）
2. **JSON配置导入**：支持从3GPP格式的JSON文件导入clusters配置
3. **自动帧生成**：自动将JSON中的delay和power参数转换为设备帧格式
4. **状态显示**：显示导入状态和应用结果

## 修改的文件

### 1. UI/MainWindow.py
- 添加了3个新控件：
  - `pushButton_import_config`：导入配置按钮
  - `pushButton_apply_config`：应用配置按钮（导入后才启用）
  - `label_config_status`：配置状态标签
- 扩展了 `comboBox_path` 从16个选项到24个选项（支持24个多径）

### 2. main.py
- 添加了 `json` 导入
- 添加了全局变量 `imported_config` 用于存储导入的配置
- 新增函数：
  - `import_json_config()`：导入JSON配置文件
  - `apply_json_config()`：应用导入的配置
- 连接按钮到处理函数

## 使用方法

### 1. 导入配置
1. 点击"导入配置"按钮
2. 选择一个JSON文件（例如：3GPP_UMa_Stochastic.json）
3. 系统会验证文件格式并显示导入的clusters数量
4. 如果成功，"应用配置"按钮会被启用

### 2. 应用配置
1. 确保设备已连接（TCP连接已建立）
2. 选择输入输出端口（通过界面上的下拉框）
3. 点击"应用配置"按钮
4. 系统会自动生成并发送配置帧到设备

## JSON格式要求

JSON文件必须包含 `clusters` 数组，每个cluster需要有：
- `delay`：时延（单位：秒）
- `power`：归一化相对功率（0-1之间）

示例：
```json
{
    "clusters": [
        {
            "delay": 0.0,
            "power": 0.172694041076852,
            ...
        },
        {
            "delay": 7.83474628894682e-09,
            "power": 0.19189345022654475,
            ...
        }
    ]
}
```

## 参数转换

### 时延转换
- JSON中的delay（秒）→ ns → 时钟周期数
- 公式：`path_delay = round(delay * 1e9 / CLK_TS)`
- CLK_TS = 5ns

### 功率转换
- JSON中的power（归��化功率）→ 衰减dB → k值
- 公式：
  ```python
  atten_db = -10 * log10(power)
  k = round(10 ** (-atten_db / 10 / 2) * (2 ** 15))
  ```

## 帧格式

应用配置时，会为每个多径发送以下参数子帧：
1. ID=2：多径使能（启用）
2. ID=3：多径时延（从JSON的delay转换）
3. ID=7：多径幅值衰减（从JSON的power转换）
4. ID=34：分数时延（默认0）
5. ID=4：多径频移（默认0）
6. ID=32：相偏（默认0）
7. ID=5：瑞利衰落使能（默认0）

对于未使用的多径（超过JSON中的clusters数量），会发送禁用指令（ID=2，值=0）。

## 测试

已创建测试脚本 `test_config_import.py`，可以独立运行测试配置导入和帧生成功能：

```bash
python test_config_import.py
```

测试结果显示：
- 成功读取12个clusters
- 正确转换delay和power参数
- 生成552字节的参数数据
- 完整帧560字节（包含帧头、帧长、帧尾）

## 注意事项

1. **多径数量限制**：最多支持24个多径，超过部分会被忽略
2. **设备连接**：应用配置前必须先建立TCP连接
3. **端口选择**：使用界面上当前选择的输入输出端口
4. **不影响原有功能**：所有原有的手动配置功能保持不变
5. **帧长度限制**：帧长度最大不要超过4000字节（当前实现远未达到限制）

## 界面布局

新按钮位于界面中部：
- 位置：(550, 290) - (721, 321)
- "导入配置"按钮在左，"应用配置"按钮在右
- 状态标签显示在按钮下方

## 错误处理

系统会处理以下错误情况：
- JSON格式错误
- 文件读取失败
- 缺少必需字段
- 设备未连接
- 发送失败

所有错误都会通过状态栏和状态标签提示用户。

