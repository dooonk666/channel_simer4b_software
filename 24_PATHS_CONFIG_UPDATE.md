# 24条多径配置功能更新说明

## 更新日期
2026-01-22

## 功能概述
将原来的12条多径扩展为24条多径，实现更完整的信道模拟。

## 实现原理

### 12条径 → 24条径扩展策略

从JSON配置文件读取12个cluster，扩展生成24条多径：

1. **前12条径（索引0-11）**：正常配置
   - 瑞利衰落：**关闭**（ID=5, 值=0）
   - 时延：直接从cluster读取
   - 功率衰减：`atten_db = -10 * log10(power)`
   
2. **后12条径（索引12-23）**：交叉极化配置
   - 瑞利衰落：**开启**（ID=5, 值=1）
   - 时延：与对应的前12条径相同
   - 功率衰减：`atten_db = -10 * log10(power) + xpr_db`
   - 说明：xpr_db是交叉极化比，从JSON配置文件中读取

## 代码修改详情

### 修改位置
- 文件：`main.py`
- 函数：`apply_json_config()`
- 行数：约815-1000行

### 关键变量说明

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `num_clusters` | int | 从JSON读取的cluster数量，最多12个 |
| `delay` | float | 多径时延（秒），从cluster读取 |
| `power` | float | 归一化相对功率，从cluster读取 |
| `xpr_db` | float | 交叉极化比（dB），从cluster读取，仅用于后12条径 |
| `atten_db` | float | 衰减值（dB），计算得出 |
| `k` | int | 硬件衰减系数，通过atten_db计算 |

### 每条多径发送的参数

每条多径发送5个参数帧：

| 序号 | 参数名称 | ID | 字节数 | 说明 |
|------|---------|-------|--------|------|
| 1 | 多径使能 | 2 | 1 | 根据界面checkBox_path_en复选框 |
| 2 | 多径时延 | 3 | 2 | 从cluster.delay计算 |
| 3 | 多径幅值衰减 | 7 | 2 | 从cluster.power（+xpr_db）计算 |
| 4 | 多径频移 | 4 | 4 | 固定为0 |
| 5 | 瑞利衰落使能 | 5 | 1 | 前12条=0，后12条=1 |

## 公式说明

### 前12条径的衰减计算
```
atten_db = -10 * log10(power)
k = round(10^(-atten_db / 20) * 2^15)
```

### 后12条径的衰减计算
```
atten_db = -10 * log10(power) + xpr_db
k = round(10^(-atten_db / 20) * 2^15)
```

### 时延转换
```
path_delay_ns = delay * 1e9
path_delay_cycles = round(path_delay_ns / 5)  // CLK_TS = 5ns
```

## JSON配置文件格式

```json
{
    "clusters": [
        {
            "delay": 0.0,              // 时延（秒）
            "power": 0.172694,         // 归一化功率
            "xpr_db": 4.412167,        // 交叉极化比（dB）
            "aoa_phi": 21.627924,
            "zoa_theta": -0.741756,
            ...
        },
        ...
    ]
}
```

## 调试输出示例

```
==============================================================
【应用配置 - 参数转换详情】
输入端口: 0, 输出端口: 0
配置cluster数量: 12 (将生成 24 条多径)
--------------------------------------------------------------
【前12条径 - 瑞利衰落关闭】
多径0: delay=0.0s -> 0周期, power=0.172694 -> k=29551 (衰减7.63dB)
多径1: delay=7.83e-09s -> 2周期, power=0.191893 -> k=29024 (衰减7.17dB)
...
--------------------------------------------------------------
【后12条径 - 瑞利衰落开启，衰减加上xpr_db】
多径12: delay=0.0s -> 0周期, power=0.172694, xpr_db=4.41dB -> k=18606 (总衰减12.04dB)
多径13: delay=7.83e-09s -> 2周期, power=0.191893, xpr_db=10.29dB -> k=8673 (总衰减17.46dB)
...
==============================================================
```

## 状态显示

- 状态栏消息：`已应用配置：24条多径已发送（12个cluster扩展）`
- 配置状态标签：`已应用：24条多径`

## 测试建议

1. **导入12个cluster的JSON配置文件**
2. **勾选"多径使能"复选框**
3. **点击"应用配置"按钮**
4. **查看控制台输出**：
   - 前12条径应显示瑞利衰落关闭
   - 后12条径应显示瑞利衰落开启
   - 后12条径的衰减应该比前12条增加xpr_db的值
5. **验证设备收到的参数是否正确**

## 注意事项

1. 如果JSON配置文件的cluster数量少于12个，将只生成实际数量的两倍多径
2. 如果cluster数量超过12个，将只使用前12个
3. 界面上的"多径使能"复选框控制所有24条径的使能状态
4. 后12条径的时延与前12条径完全相同，只是衰减不同
5. 所有多径的频移都设置为0

## 技术背景

这种配置方式符合3GPP信道模型中的双极化配置：
- 前12条径代表一个极化方向（如垂直极化）
- 后12条径代表交叉极化方向（如水平极化）
- xpr_db（交叉极化比）描述了两个极化方向之间的功率比
- 瑞利衰落使能用于模拟快衰落效应

