# 帧结构说明文档

## 概述

本文档详细说明信道模拟器软件生成的通信帧结构和 JSON 配置的解析过程。

---

## 1. 完整帧结构

```
┌────────────┬───────────┬──────────────────┬───────────┐
│  帧头       │   帧长     │   数据部分        │   帧尾     │
│  4字节      │   2字节    │   N字节          │   2字节    │
└────────────┴───────────┴──────────────────┴───────────┘
```

### 各部分说明

| 字段 | 长度 | 说明 | 值 |
|------|------|------|-----|
| 帧头 | 4字节 | 固定标识符 | `0xFD 0xB1 0x85 0x40` |
| 帧长 | 2字节 | 数据部分的字节数（小端） | 根据数据部分计算 |
| 数据部分 | N字节 | 由多个子帧组成 | 见下文 |
| 帧尾 | 2字节 | 固定结束符 | `0xAE 0x86` |

**示例完整帧（十六进制）：**
```
fd b1 85 40  22 00  02 01 00 00 01 03 02 00 00 14 00 ... ae 86
 ︳帧头︳    ︳帧长︳  ︳────────数据部分────────────︳   ︳帧尾︳
```

---

## 2. 子帧结构

数据部分由多个子帧组成，每个子帧的结构如下：

```
┌──────┬──────────┬──────┬──────┬──────────────┐
│  ID  │  字节数   │ 端口  │ 路径  │   参数值      │
│ 1字节│  1字节    │1字节 │1字节 │  1/2/4字节   │
└──────┴──────────┴──────┴──────┴──────────────┘
```

### 字段详解

| 字段 | 长度 | 说明 |
|------|------|------|
| **ID** | 1字节 | 参数类型标识符（见ID表） |
| **字节数** | 1字节 | 参数值的字节数（1/2/4） |
| **端口** | 1字节 | `port_in * 16 + port_out` |
| **路径** | 1字节 | 多径编号（0-23） |
| **参数值** | 1/2/4字节 | 参数的实际值（小端） |

### 常用 ID 对照表

| ID | 名称 | 字节数 | 说明 |
|----|------|--------|------|
| 2  | 多径使能 | 1 | 0=禁用, 1=启用 |
| 3  | 多径时延 | 2 | 时钟周期数（5ns/周期） |
| 4  | 多径频移 | 4 | 频率偏移值 |
| 5  | 瑞利衰���使能 | 1 | 0=禁用, 1=启用 |
| 7  | 多径幅值衰减 | 2 | k值（衰减系数） |
| 32 | 相位偏移 | 2 | 相位值 |
| 34 | 分数时延 | 1 | 精细时延调整 |

---

## 3. JSON 配置格式

### 输入格式

```json
{
  "clusters": [
    {
      "delay": 0.0000001,    // 延迟，单位：秒
      "power": 1.0            // 归一化功率（0-1）
    },
    {
      "delay": 0.0000005,
      "power": 0.5
    }
  ]
}
```

### 参数转换规则

#### 3.1 延迟转换

```
JSON delay (秒) → 纳秒 → 时钟周期数
```

**转换公式：**
```python
CLK_TS = 5  # 时钟周期 5ns
path_delay_ns = delay * 1e9
path_delay_cycles = round(path_delay_ns / CLK_TS)
```

**示例：**
- JSON: `delay = 0.0000001` (100ns)
- 转换: `100ns / 5ns = 20` 时钟周期

#### 3.2 功率转换

```
JSON power (0-1) → 衰减dB → k值
```

**转换公式：**
```python
atten_db = -10 * log10(power)
k = round(10 ** (-atten_db / 10 / 2) * (2 ** 15))
```

**示例：**
- JSON: `power = 1.0`
  - 衰减: `-10 * log10(1.0) = 0dB`
  - k值: `10^(0/10/2) * 32768 = 32768`

- JSON: `power = 0.5`
  - 衰减: `-10 * log10(0.5) = 3.01dB`
  - k值: `10^(-3.01/10/2) * 32768 = 23170`

---

## 4. 完整示例

### 输入 JSON
```json
{
  "clusters": [
    {"delay": 0.0000001, "power": 1.0},
    {"delay": 0.0000005, "power": 0.5}
  ]
}
```

### 生成的子帧（多径0）

| 参数 | 子帧（hex） | 解析 |
|------|------------|------|
| 使能 | `02 01 00 00 01` | ID=2, 1字节, 端口=0x00, 路径=0, 值=1 |
| 时延 | `03 02 00 00 14 00` | ID=3, 2字节, 端口=0x00, 路径=0, 值=20 |
| 衰减 | `07 02 00 00 00 80` | ID=7, 2字节, 端口=0x00, 路径=0, 值=32768 |

### 生成的子帧（多径1）

| 参数 | 子帧（hex） | 解析 |
|------|------------|------|
| 使能 | `02 01 00 01 01` | ID=2, 1字节, 端口=0x00, 路径=1, 值=1 |
| 时延 | `03 02 00 01 64 00` | ID=3, 2字节, 端口=0x00, 路径=1, 值=100 |
| 衰减 | `07 02 00 01 82 5a` | ID=7, 2字节, 端口=0x00, 路径=1, 值=23170 |

### 完整帧（42字节）

```
fd b1 85 40  // 帧头
22 00        // 帧长=34字节（0x0022）
02 01 00 00 01  03 02 00 00 14 00  07 02 00 00 00 80  // 多径0
02 01 00 01 01  03 02 00 01 64 00  07 02 00 01 82 5a  // 多径1
ae 86        // 帧尾
```

---

## 5. 程序调试输出

运行程序并导入/应用 JSON 配置时，会在���制台输出以下信息：

### 5.1 导入 JSON 时
```
============================================================
【从JSON读取的数据】
文件路径: D:\config.json
总cluster数量: 2
------------------------------------------------------------
Cluster 0: delay=1e-07s, power=1.0
Cluster 1: delay=5e-07s, power=0.5
============================================================
```

### 5.2 应用配置时
```
============================================================
【应用配置 - 参数转换详情】
输入端口: 0, 输出端口: 0
配置cluster数量: 2
------------------------------------------------------------
多径0: delay=1e-07s -> 20周期, power=1.0 -> k=32768 (衰减-0.00dB)
多径1: delay=5e-07s -> 100周期, power=0.5 -> k=23170 (衰减3.01dB)
------------------------------------------------------------
【生成的完整帧数据】
帧总长度: 42 字节
帧完���内容 (hex): fdb1854022000201000001030200001400...
------------------------------------------------------------
帧结构解析:
  帧头 (4字节): fdb18540 (固定为 fd b1 85 40)
  帧长 (2字节): 2200 (小端值=34字节)
  数据部分 (34字节): 020100000103020000140007020000008...
  帧尾 (2字节): ae86 (固定为 ae 86)
------------------------------------------------------------
关键子帧详情 (前3个多径的使能、时延、衰减):
  多径0-使能: 0201000001
    └─ ID=02, 字节数=1, 端口=00, 路径=00, 值=1
  多径0-时延: 030200001400
    └─ ID=03, 字节数=2, 端口=00, 路径=00, 值=20
  多径0-衰减: 070200000080
    └─ ID=07, 字节数=2, 端口=00, 路径=00, 值=32768
============================================================
```

---

## 6. 工具脚本

### 查看帧结构演示

运行以下脚本可以查看详细的帧结构演示：

```bash
python show_frame_structure.py
```

该脚本会生成示例帧并详细展示每个字节的含义。

---

## 7. 注意事项

1. **字节序**：所有多字节数值使用**小端序**（little-endian）
2. **最大多径数**：系统支持最多 **24 条多径**（路径编号 0-23）
3. **时钟周期**：时延以 **5ns** 为单位
4. **功率范围**：归一化功率应在 **0-1** 之间

---

## 8. 常见问题

**Q: 为什么我的时延值看起来很大？**  
A: 时延值是以时钟周期数表示的。例如 100ns 的延迟会转换为 20 个时钟周期（100ns ÷ 5ns = 20）。

**Q: k 值是如何计算的？**  
A: k 值用于表示衰减系数。功率为 1.0 时 k=32768（即 2^15），功率越小 k 值越小。

**Q: 如何查看实际发送的帧数据？**  
A: 在应用配置时，控制台会打印完整的帧数据（十六进制格式）。

---

**文档版本**: v1.0  
**最后更新**: 2026-01-20

